<div class="min-h-screen bg-gray-50 flex flex-col justify-center py-12 sm:px-6 lg:px-8">
  <div class="sm:mx-auto sm:w-full sm:max-w-md">
    <form [formGroup]="formGroup" class="bg-white py-8 px-4 shadow sm:rounded-lg sm:px-10">
      
      <!-- Step 1: Email/Username Input -->
      <div *ngIf="currentStep === 'email'" class="space-y-6">
        <!-- Header -->
        <div class="text-center">
          <div class="mx-auto h-12 w-12 bg-blue-100 rounded-full flex items-center justify-center mb-4">
            <i class="fas fa-key text-blue-600 text-xl"></i>
          </div>
          <h3 class="text-lg font-medium text-gray-900">Forgot Password</h3>
          <p class="text-sm text-gray-600 mt-2">
            Enter your email or username to receive a verification code
          </p>
        </div>

        <!-- Success/Error Messages -->
        <div *ngIf="successMessage" class="bg-green-50 border border-green-200 rounded-md p-4">
          <div class="flex">
            <i class="fas fa-check-circle text-green-400"></i>
            <p class="ml-3 text-sm text-green-800">{{ successMessage }}</p>
          </div>
        </div>

        <div *ngIf="errorMessage" class="bg-red-50 border border-red-200 rounded-md p-4">
          <div class="flex">
            <i class="fas fa-exclamation-circle text-red-400"></i>
            <p class="ml-3 text-sm text-red-800">{{ errorMessage }}</p>
          </div>
        </div>

        <!-- Email/Username Field -->
        <div>
          <label for="identifier" class="block text-sm font-medium text-gray-700">
            Email or Username
          </label>
          <div class="mt-1 relative">
            <input
              id="identifier"
              name="identifier"
              type="text"
              formControlName="identifier"
              class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Enter your email or username"
              [class.border-red-300]="formGroup.get('identifier')?.invalid && formGroup.get('identifier')?.touched"
            />
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
              <i class="fas fa-user text-gray-400"></i>
            </div>
          </div>
          <div *ngIf="formGroup.get('identifier')?.invalid && formGroup.get('identifier')?.touched" class="mt-1 text-sm text-red-600">
            {{ getValidationMessage('identifier') }}
          </div>
        </div>

        <!-- Send Code Button -->
        <button
          type="button"
          (click)="onSendCode()"
          [disabled]="!formGroup.get('identifier')?.valid || isLoading"
          class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <i *ngIf="isLoading" class="fas fa-spinner fa-spin mr-2"></i>
          <i *ngIf="!isLoading" class="fas fa-paper-plane mr-2"></i>
          {{ isLoading ? 'Sending...' : 'Send Code' }}
        </button>
      </div>

      <!-- Step 2: OTP Verification -->
      <div *ngIf="currentStep === 'otp'" class="space-y-6">
        <!-- Header -->
        <div class="text-center">
          <div class="mx-auto h-12 w-12 bg-green-100 rounded-full flex items-center justify-center mb-4">
            <i class="fas fa-mobile-alt text-green-600 text-xl"></i>
          </div>
          <h3 class="text-lg font-medium text-gray-900">Verification Code</h3>
          <p class="text-sm text-gray-600 mt-2">
            Enter the 4-digit code sent to your {{ userType === 'company' ? 'email' : 'phone' }}
          </p>
        </div>

        <!-- Success/Error Messages -->
        <div *ngIf="successMessage" class="bg-green-50 border border-green-200 rounded-md p-4">
          <div class="flex">
            <i class="fas fa-check-circle text-green-400"></i>
            <p class="ml-3 text-sm text-green-800">{{ successMessage }}</p>
          </div>
        </div>

        <div *ngIf="errorMessage" class="bg-red-50 border border-red-200 rounded-md p-4">
          <div class="flex">
            <i class="fas fa-exclamation-circle text-red-400"></i>
            <p class="ml-3 text-sm text-red-800">{{ errorMessage }}</p>
          </div>
        </div>

        <!-- OTP Input Fields -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-3">
            Verification Code
          </label>
          <div class="flex justify-between space-x-2">
            <input
              *ngFor="let field of otpFields; let i = index"
              [name]="'otp' + (i + 1)"
              type="text"
              maxlength="1"
              inputmode="numeric"
              pattern="[0-9]"
              class="w-16 h-16 text-center text-xl rounded border-2 border-gray-300 focus:border-blue-500 focus:outline-none"
              (input)="onOtpInput($event, i)"
              (keydown)="onOtpKeydown($event, i)"
              placeholder="0"
            />
          </div>
        </div>

        <!-- Countdown Timer -->
        <div class="text-center">
          <p class="text-sm text-gray-600">
            Time remaining: <span class="font-medium text-blue-600">{{ formatTime(countdown) }}</span>
          </p>
        </div>

        <!-- Attempts Counter -->
        <div class="text-center">
          <p class="text-sm text-gray-600">
            Attempts remaining: 
            <span class="font-medium" [class.text-red-600]="attempts >= maxAttempts" [class.text-blue-600]="attempts < maxAttempts">
              {{ maxAttempts - attempts }}
            </span>
          </p>
        </div>

        <!-- Verify Button -->
        <button
          type="button"
          (click)="onVerifyOtp()"
          [disabled]="otpFields.join('').length !== 4 || countdown <= 0 || attempts >= maxAttempts || isLoading"
          class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <i *ngIf="isLoading" class="fas fa-spinner fa-spin mr-2"></i>
          <i *ngIf="!isLoading" class="fas fa-check mr-2"></i>
          {{ isLoading ? 'Verifying...' : 'Verify Code' }}
        </button>

        <!-- Resend Button -->
        <button
          type="button"
          (click)="onResendOtp()"
          [disabled]="!canResend || isLoading"
          class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <i *ngIf="isLoading" class="fas fa-spinner fa-spin mr-2"></i>
          <i *ngIf="!isLoading" class="fas fa-redo mr-2"></i>
          {{ isLoading ? 'Sending...' : 'Resend Code' }}
        </button>
      </div>

      <!-- Step 3: New Password -->
      <div *ngIf="currentStep === 'newPassword'" class="space-y-6">
        <!-- Header -->
        <div class="text-center">
          <div class="mx-auto h-12 w-12 bg-green-100 rounded-full flex items-center justify-center mb-4">
            <i class="fas fa-lock text-green-600 text-xl"></i>
          </div>
          <h3 class="text-lg font-medium text-gray-900">New Password</h3>
          <p class="text-sm text-gray-600 mt-2">
            Enter your new password
          </p>
        </div>

        <!-- Success/Error Messages -->
        <div *ngIf="successMessage" class="bg-green-50 border border-green-200 rounded-md p-4">
          <div class="flex">
            <i class="fas fa-check-circle text-green-400"></i>
            <p class="ml-3 text-sm text-green-800">{{ successMessage }}</p>
          </div>
        </div>

        <div *ngIf="errorMessage" class="bg-red-50 border border-red-200 rounded-md p-4">
          <div class="flex">
            <i class="fas fa-exclamation-circle text-red-400"></i>
            <p class="ml-3 text-sm text-red-800">{{ errorMessage }}</p>
          </div>
        </div>

        <!-- New Password Field -->
        <div>
          <label for="newPassword" class="block text-sm font-medium text-gray-700">
            New Password
          </label>
          <div class="mt-1 relative">
            <input
              id="newPassword"
              name="newPassword"
              type="password"
              formControlName="newPassword"
              class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Enter new password"
              [class.border-red-300]="formGroup.get('newPassword')?.invalid && formGroup.get('newPassword')?.touched"
            />
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
              <i class="fas fa-lock text-gray-400"></i>
            </div>
          </div>
          <div *ngIf="formGroup.get('newPassword')?.invalid && formGroup.get('newPassword')?.touched" class="mt-1 text-sm text-red-600">
            {{ getValidationMessage('newPassword') }}
          </div>
          <p class="mt-1 text-xs text-gray-500">
            Must be at least 8 characters with uppercase, lowercase, numbers, and special characters
          </p>
        </div>

        <!-- Confirm Password Field -->
        <div>
          <label for="confirmPassword" class="block text-sm font-medium text-gray-700">
            Confirm Password
          </label>
          <div class="mt-1 relative">
            <input
              id="confirmPassword"
              name="confirmPassword"
              type="password"
              formControlName="confirmPassword"
              class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Confirm new password"
              [class.border-red-300]="formGroup.get('confirmPassword')?.invalid && formGroup.get('confirmPassword')?.touched"
            />
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
              <i class="fas fa-lock text-gray-400"></i>
            </div>
          </div>
          <div *ngIf="formGroup.get('confirmPassword')?.invalid && formGroup.get('confirmPassword')?.touched" class="mt-1 text-sm text-red-600">
            {{ getValidationMessage('confirmPassword') }}
          </div>
        </div>

        <!-- Save Button -->
        <button
          type="button"
          (click)="onSavePassword()"
          [disabled]="!isStepValid() || isLoading"
          class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <i *ngIf="isLoading" class="fas fa-spinner fa-spin mr-2"></i>
          <i *ngIf="!isLoading" class="fas fa-save mr-2"></i>
          {{ isLoading ? 'Saving...' : 'Save Password' }}
        </button>
      </div>

      <!-- Cancel Button (Common for all steps) -->
      <div class="mt-6">
        <button
          type="button"
          (click)="onCancel()"
          class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
        >
          <i class="fas fa-times mr-2"></i>
          Cancel
        </button>
      </div>

      <!-- Back to Login Link -->
      <div class="text-center mt-4">
        <a href="/login" class="text-sm text-gray-500 hover:text-gray-700">
          <i class="fas fa-arrow-left mr-1"></i>
          Back to Login
        </a>
      </div>
    </form>
  </div>
</div> 